var app=angular.module("vkSample",["ngRoute","ngCookies","ui.bootstrap"]);app.config(["$routeProvider","$locationProvider",function(e,t){e.when("/",{templateUrl:"static/tmpl/notes.html",controller:"NotesController"}).when("/details/:id",{templateUrl:"static/tmpl/details.html",controller:"DetailsController"}),t.html5Mode(!0)}]),app.directive("authDirective",function(){return{templateUrl:"static/tmpl/authDirective.html"}}),app.filter("firstChar",function(){return function(e){return e.charAt(0).toUpperCase()}}),app.filter("setPlainText",function(){return function(e){return e.replace(/<(.|\n)*?>/g," ")}}),app.controller("DetailsController",["$scope","$routeParams","$http","$location","User",function(e,t,o,n,r){"ngInject";e.renderHtml=e.$parent.renderHtml,e.convertDate=e.$parent.convertDate,e.paramsToString=e.$parent.paramsToString,e.id=t.id,e.getNoteInfo=function(){var t={note_id:this.id,need_wiki:1},n="https://api.vk.com/method/notes.getById?"+this.paramsToString(t,!0)+r.getUrlParams();o.jsonp(n).success(function(t,o,n,r){e.date=t.response.date,e.title=t.response.title,e.text=t.response.text_wiki?t.response.text_wiki:t.response.text,e.url=t.response.view_url,e.editTitle=e.title,e.editText=e.text,e.IsLoadPending=!1}).error(function(t,o,n,r){e.IsLoadPending=!1,alert("Server responsed with the error message. Please try again."),console.log(t)})},e.deleteNote=function(){e.IsDeletePending=!0;var t={note_id:this.id},s="https://api.vk.com/method/notes.delete?"+this.paramsToString(t,!0)+r.getUrlParams();o.jsonp(s).success(function(t,o,r,s){e.IsDeletePending=!1,n.path("/").replace()}).error(function(t,o,n,r){e.IsDeletePending=!1,alert("Server responsed with the error message. Please try again."),console.log(t)})},e.editNote=function(){e.IsInEdit=!0},e.addNote=function(){e.IsEditPending=!0;var t={title:e.editTitle,text:e.editText,privacy_view:"only_me",privacy_comment:"only_me"};if(e.IsExists){t.note_id=this.id;var s="https://api.vk.com/method/notes.edit?"+this.paramsToString(t,!0)+r.getUrlParams();o.jsonp(s).success(function(t,o,n,r){e.title=e.editTitle,e.text=e.editText,e.IsEditPending=!1,e.IsInEdit=!1}).error(function(t,o,n,r){e.IsEditPending=!1,alert("Server responsed with the error message. Please try again."),console.log(t)})}else{var s="https://api.vk.com/method/notes.add?"+this.paramsToString(t,!0)+r.getUrlParams();o.jsonp(s).success(function(t,o,r,s){var a=t.response;e.IsEditPending=!1,n.path("/details/"+a).replace()}).error(function(t,o,n,r){e.IsEditPending=!1,alert("Server responsed with the error message. Please try again."),console.log(t)})}},e.cancelEdit=function(){e.IsExists?(e.IsInEdit=!1,e.editTitle=e.title,e.editText=e.text):n.path("/")},e.saveText=function(e){var t=e.target.innerHTML;t=t.replace(/<div><br><\/div>/g,"<br/>").replace(/<div>/g,"<br/>").replace(/<br>/g,"<br/>").replace(/<\/div>/g,""),this.editText=t},e.IsEditPending=!1,e.IsDeletePending=!1,t.id==-1?(e.IsExists=!1,e.IsInEdit=!0,e.btnOk="create",e.IsLoadPending=!1):(e.IsLoadPending=!0,e.IsExists=!0,e.IsInEdit=!1,e.btnOk="apply",e.getNoteInfo())}]),app.controller("AuthController",["$scope","$location","$window","$cookies","User",function(e,t,o,n,r){"ngInject";e.paramsToString=e.$parent.paramsToString,e.openProfile=function(){o.open("https://vk.com/"+e.userHref,"_blank")},e.openTop=function(){t.path("/")};var s=t.hash(),a=n.get("VkNotebookAccess");s?(n.put("VkNotebookAccess",s),r.setToken(s,function(){t.hash("")})):a&&r.setToken(a),e.$watch(function(){return r.getFirstName()},function(t){e.userName=t}),e.$watch(function(){return r.getLastName()},function(t){e.userLastName=t}),e.$watch(function(){return r.getHref()},function(t){e.userHref=t}),e.$watch(function(){return r.getPhoto()},function(t){e.photo=t}),e.$watch(function(){return r.hasPhoto()},function(t){e.hasPhoto=t}),e.$watch(function(){return r.isAuthorized()},function(t){e.isUserLoggedIn=t}),e.logout=function(){n.remove("VkNotebookAccess"),r.resetParams(function(){t.path("/")})},e.login=function(){var e={client_id:5590999,display:"page",redirect_uri:"https://nsrg-angular-api.herokuapp.com%3F",scope:"notes,offline",response_type:"token",v:"5.53"};o.open("https://oauth.vk.com/authorize?"+this.paramsToString(e),"_self")}}]),app.controller("MainController",["$scope","$sce",function(e,t){"ngInject";e.renderHtml=function(e){return t.trustAsHtml(e)},e.paramsToString=function(e,t,o){var n="";for(var r in e)n+=r+"="+e[r],n+=o?o:"&";return t&&(n=n.substring(0,n.length-1)),n},e.convertDate=function(e){var t=new Date(1e3*e),o=t.getHours(),n="0"+t.getMinutes(),r=t.getFullYear(),s=t.getMonth(),a=t.getDate(),i={0:"jan",1:"feb",2:"mar",3:"apr",4:"may",5:"jun",6:"jul",7:"aug",8:"sep",9:"oct",10:"nov",11:"dec"},c=o+":"+n.substr(-2)+", "+a+" "+i[s]+" "+r;return c}}]),app.controller("NotesController",["$scope","$http","$location","User",function(e,t,o,n){"ngInject";e.isUserLoggedIn=!1,e.isNotesLoading=!1,e.IsNotesLoaded=!1,e.IsAllNotesLoaded=!1,e.notes=[],e.renderHtml=e.$parent.renderHtml,e.convertDate=e.$parent.convertDate,e.paramsToString=e.$parent.paramsToString,e.offset=0,e.count=10,e.btnLoad="Loading...",e.$watch(function(){return n.isAuthorized()},function(t){t?(e.isUserLoggedIn=!0,e.isNotesLoading=!0,e.IsAllNotesLoaded=!1,e.$emit("loadNotes")):(e.isUserLoggedIn=!1,e.isNotesLoading=!1,e.IsAllNotesLoaded=!1,e.IsNotesLoaded=!1,e.btnLoad="Loading...",e.notes=[],e.offset=0)}),e.getNotes=function(){e.btnLoad="Loading...",e.$emit("loadNotes")},e.$on("loadNotes",function(o){var r={offset:e.offset,count:e.count,sort:0};e.isNotesLoading=!0;var s="https://api.vk.com/method/notes.get?"+e.paramsToString(r)+n.getUrlParams();t.jsonp(s).success(function(t,o,n,r){var s=t.response.items,a=s.length,i=t.response.count;e.offset+=a,e.IsAllNotesLoaded=i==e.offset,e.btnLoad="Load more",e.$emit("notesLoaded",s)}).error(function(t,o,n,r){e.btnLoad="Load more",e.isNotesLoading=!1,e.IsNotesLoaded=!0,alert("Server responsed with the error message. Please try again."),console.log(t)})}),e.addNote=function(){o.path("/details/-1")},e.$on("notesLoaded",function(t,o){e.isNotesLoading=!1,e.IsNotesLoaded=!0,e.notes=e.notes.concat(o)}),e.showDetails=function(e){o.path("/details/"+e)}}]),app.factory("User",["$http",function(e){var t=new Object,o=new Object;return o.ver="5.53",o.appId="5590999",o.redirectUrl="https://nsrg-angular-api.herokuapp.com/",t.setToken=function(e,t){for(var n=e.split(/[\=\&]+/),r=0;r<n.length;r+=2)o[n[r]]=n[r+1];o.hasOwnProperty("access_token")&&(o.isAuthorized=!0,o.getUserData(t))},t.getToken=function(){return o.access_token},t.getFirstName=function(){return o.firstName},t.getLastName=function(){return o.lastName},t.getHref=function(){return o.href},t.hasPhoto=function(){return o.hasPhoto},t.getPhoto=function(){return o.photo},t.getId=function(){return o.id},t.getUrlParams=function(){var e="";return e+="&access_token="+o.access_token+"&v="+o.ver+"&callback=JSON_CALLBACK"},t.isAuthorized=function(){return o.isAuthorized},t.resetParams=function(e){o.isAuthorized=!1,o.access_token="",o.firstName="",o.lastName="",o.href="",o.photo="",o.hasPhoto=!1,o.id=0,e&&e()},o.getUserData=function(t){var o="https://api.vk.com/method/users.get?fields=photo_100,has_photo,domain&access_token="+this.access_token+"&v="+this.ver+"&callback=JSON_CALLBACK",n=this;e.jsonp(o).success(function(e,o,r,s){n.firstName=e.response[0].first_name,n.lastName=e.response[0].last_name,n.href=e.response[0].domain,n.photo=e.response[0].photo_100,n.hasPhoto=e.response[0].has_photo,n.id=e.response[0].id,t&&t()}).error(function(e,t,o,n){console.log(e)})},t.resetParams(),t}]);