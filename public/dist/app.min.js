var app=angular.module("vkSample",["ngRoute","ngCookies","ui.bootstrap"]);app.config(function(e,t){e.when("/",{templateUrl:"static/tmpl/notes.html",controller:"NotesController"}).when("/details/:id",{templateUrl:"static/tmpl/details.html",controller:"DetailsController"}),t.html5Mode(!0)}),app.directive("authDirective",function(){return{templateUrl:"static/tmpl/authDirective.html"}}),app.filter("firstChar",function(){return function(e){return e.charAt(0).toUpperCase()}}),app.filter("setPlainText",function(){return function(e){return e.replace(/<(.|\n)*?>/g," ")}}),app.controller("DetailsController",function(e,t,n,o,r){e.renderHtml=e.$parent.renderHtml,e.convertDate=e.$parent.convertDate,e.paramsToString=e.$parent.paramsToString,e.id=t.id,e.getNoteInfo=function(){var t={note_id:this.id,need_wiki:1},o="https://api.vk.com/method/notes.getById?"+this.paramsToString(t,!0)+r.getUrlParams();n.jsonp(o).success(function(t,n,o,r){e.date=t.response.date,e.title=t.response.title,e.text=t.response.text_wiki?t.response.text_wiki:t.response.text,e.url=t.response.view_url,e.editTitle=e.title,e.editText=e.text,e.IsLoadPending=!1}).error(function(t,n,o,r){e.IsLoadPending=!1,alert("Server responsed with the error message. Please try again."),console.log(t)})},e.deleteNote=function(){e.IsDeletePending=!0;var t={note_id:this.id},s="https://api.vk.com/method/notes.delete?"+this.paramsToString(t,!0)+r.getUrlParams();n.jsonp(s).success(function(t,n,r,s){e.IsDeletePending=!1,o.path("/").replace()}).error(function(t,n,o,r){e.IsDeletePending=!1,alert("Server responsed with the error message. Please try again."),console.log(t)})},e.editNote=function(){e.IsInEdit=!0},e.addNote=function(){e.IsEditPending=!0;var t={title:e.editTitle,text:e.editText,privacy_view:"only_me",privacy_comment:"only_me"};if(e.IsExists){t.note_id=this.id;var s="https://api.vk.com/method/notes.edit?"+this.paramsToString(t,!0)+r.getUrlParams();n.jsonp(s).success(function(t,n,o,r){e.title=e.editTitle,e.text=e.editText,e.IsEditPending=!1,e.IsInEdit=!1}).error(function(t,n,o,r){e.IsEditPending=!1,alert("Server responsed with the error message. Please try again."),console.log(t)})}else{var s="https://api.vk.com/method/notes.add?"+this.paramsToString(t,!0)+r.getUrlParams();n.jsonp(s).success(function(t,n,r,s){var a=t.response;e.IsEditPending=!1,o.path("/details/"+a).replace()}).error(function(t,n,o,r){e.IsEditPending=!1,alert("Server responsed with the error message. Please try again."),console.log(t)})}},e.cancelEdit=function(){e.IsExists?(e.IsInEdit=!1,e.editTitle=e.title,e.editText=e.text):o.path("/")},e.saveText=function(e){var t=e.target.innerHTML;t=t.replace(/<div><br><\/div>/g,"<br/>").replace(/<div>/g,"<br/>").replace(/<br>/g,"<br/>").replace(/<\/div>/g,""),this.editText=t},e.IsEditPending=!1,e.IsDeletePending=!1,t.id==-1?(e.IsExists=!1,e.IsInEdit=!0,e.btnOk="create",e.IsLoadPending=!1):(e.IsLoadPending=!0,e.IsExists=!0,e.IsInEdit=!1,e.btnOk="apply",e.getNoteInfo())}),app.controller("AuthController",function(e,t,n,o,r){e.paramsToString=e.$parent.paramsToString,e.openProfile=function(){n.open("https://vk.com/"+e.userHref,"_blank")},e.openTop=function(){t.path("/")};var s=t.hash(),a=o.get("VkNotebookAccess");s?(o.put("VkNotebookAccess",s),r.setToken(s,function(){t.hash("")})):a&&r.setToken(a),e.$watch(function(){return r.getFirstName()},function(t){e.userName=t}),e.$watch(function(){return r.getLastName()},function(t){e.userLastName=t}),e.$watch(function(){return r.getHref()},function(t){e.userHref=t}),e.$watch(function(){return r.getPhoto()},function(t){e.photo=t}),e.$watch(function(){return r.hasPhoto()},function(t){e.hasPhoto=t}),e.$watch(function(){return r.isAuthorized()},function(t){e.isUserLoggedIn=t}),e.logout=function(){o.remove("VkNotebookAccess"),r.resetParams(function(){t.path("/")})},e.login=function(){var e={client_id:5590999,display:"page",redirect_uri:"https://nsrg-angular-api.herokuapp.com%3F",scope:"notes,offline",response_type:"token",v:"5.53"};n.open("https://oauth.vk.com/authorize?"+this.paramsToString(e),"_self")}}),app.controller("MainController",function(e,t){e.renderHtml=function(e){return t.trustAsHtml(e)},e.paramsToString=function(e,t,n){var o="";for(var r in e)o+=r+"="+e[r],o+=n?n:"&";return t&&(o=o.substring(0,o.length-1)),o},e.convertDate=function(e){var t=new Date(1e3*e),n=t.getHours(),o="0"+t.getMinutes(),r=t.getFullYear(),s=t.getMonth(),a=t.getDate(),i={0:"jan",1:"feb",2:"mar",3:"apr",4:"may",5:"jun",6:"jul",7:"aug",8:"sep",9:"oct",10:"nov",11:"dec"},c=n+":"+o.substr(-2)+", "+a+" "+i[s]+" "+r;return c}}),app.controller("NotesController",function(e,t,n,o){e.isUserLoggedIn=!1,e.isNotesLoading=!1,e.IsNotesLoaded=!1,e.IsAllNotesLoaded=!1,e.notes=[],e.renderHtml=e.$parent.renderHtml,e.convertDate=e.$parent.convertDate,e.paramsToString=e.$parent.paramsToString,e.offset=0,e.count=10,e.btnLoad="Loading...",e.$watch(function(){return o.isAuthorized()},function(t){t?(e.isUserLoggedIn=!0,e.isNotesLoading=!0,e.IsAllNotesLoaded=!1,e.$emit("loadNotes")):(e.isUserLoggedIn=!1,e.isNotesLoading=!1,e.IsAllNotesLoaded=!1,e.IsNotesLoaded=!1,e.btnLoad="Loading...",e.notes=[],e.offset=0)}),e.getNotes=function(){e.btnLoad="Loading...",e.$emit("loadNotes")},e.$on("loadNotes",function(n){var r={offset:e.offset,count:e.count,sort:0};e.isNotesLoading=!0;var s="https://api.vk.com/method/notes.get?"+e.paramsToString(r)+o.getUrlParams();t.jsonp(s).success(function(t,n,o,r){var s=t.response.items,a=s.length,i=t.response.count;e.offset+=a,e.IsAllNotesLoaded=i==e.offset,e.btnLoad="Load more",e.$emit("notesLoaded",s)}).error(function(t,n,o,r){e.btnLoad="Load more",e.isNotesLoading=!1,e.IsNotesLoaded=!0,alert("Server responsed with the error message. Please try again."),console.log(t)})}),e.addNote=function(){n.path("/details/-1")},e.$on("notesLoaded",function(t,n){e.isNotesLoading=!1,e.IsNotesLoaded=!0,e.notes=e.notes.concat(n)}),e.showDetails=function(e){n.path("/details/"+e)}}),app.factory("User",function(e){var t=new Object,n=new Object;return n.ver="5.53",n.appId="5590999",n.redirectUrl="https://nsrg-angular-api.herokuapp.com/",t.setToken=function(e,t){for(var o=e.split(/[\=\&]+/),r=0;r<o.length;r+=2)n[o[r]]=o[r+1];n.hasOwnProperty("access_token")&&(n.isAuthorized=!0,n.getUserData(t))},t.getToken=function(){return n.access_token},t.getFirstName=function(){return n.firstName},t.getLastName=function(){return n.lastName},t.getHref=function(){return n.href},t.hasPhoto=function(){return n.hasPhoto},t.getPhoto=function(){return n.photo},t.getId=function(){return n.id},t.getUrlParams=function(){var e="";return e+="&access_token="+n.access_token+"&v="+n.ver+"&callback=JSON_CALLBACK"},t.isAuthorized=function(){return n.isAuthorized},t.resetParams=function(e){n.isAuthorized=!1,n.access_token="",n.firstName="",n.lastName="",n.href="",n.photo="",n.hasPhoto=!1,n.id=0,e&&e()},n.getUserData=function(t){var n="https://api.vk.com/method/users.get?fields=photo_100,has_photo,domain&access_token="+this.access_token+"&v="+this.ver+"&callback=JSON_CALLBACK",o=this;e.jsonp(n).success(function(e,n,r,s){o.firstName=e.response[0].first_name,o.lastName=e.response[0].last_name,o.href=e.response[0].domain,o.photo=e.response[0].photo_100,o.hasPhoto=e.response[0].has_photo,o.id=e.response[0].id,t&&t()}).error(function(e,t,n,o){console.log(e)})},t.resetParams(),t});